<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hammurabi - Rule Ancient Babylon</title>
    <link rel="manifest" href="#" id="manifest-placeholder">
    <meta name="theme-color" content="#8B4513">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, #D2691E 0%, #8B4513 100%);
            min-height: 100vh;
            color: #2F1B14;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            text-align: center;
            background: rgba(139, 69, 19, 0.9);
            color: #F4E4BC;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(244, 228, 188, 0.3);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .game-board {
            background: rgba(244, 228, 188, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(139, 69, 19, 0.3);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: linear-gradient(135deg, #CD853F, #A0522D);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transform: translateY(0);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 1.8em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .controls {
            background: rgba(160, 82, 45, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid rgba(160, 82, 45, 0.3);
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #5D4037;
        }

        .slider-container {
            margin-top: 10px;
            margin-bottom: 10px;
        }

        .slider {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #D2B48C;
            outline: none;
            opacity: 0.8;
            transition: opacity 0.3s ease;
            cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
        }

        .slider:hover {
            opacity: 1;
        }

        .slider::-webkit-slider-track {
            width: 100%;
            height: 8px;
            background: linear-gradient(to right, #CD853F, #8B4513);
            border-radius: 5px;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: linear-gradient(135deg, #DAA520, #B8860B);
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            border: 2px solid white;
            transition: transform 0.2s ease;
            margin-top: -8px;
        }

        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }

        .slider::-moz-range-track {
            width: 100%;
            height: 8px;
            background: linear-gradient(to right, #CD853F, #8B4513);
            border-radius: 5px;
            border: none;
        }

        .slider::-moz-range-thumb {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: linear-gradient(135deg, #DAA520, #B8860B);
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            border: 2px solid white;
            transition: transform 0.2s ease;
            -moz-appearance: none;
            appearance: none;
        }

        .slider::-moz-range-thumb:hover {
            transform: scale(1.1);
        }

        .slider::-ms-track {
            width: 100%;
            height: 8px;
            background: transparent;
            border-color: transparent;
            color: transparent;
        }

        .slider::-ms-fill-lower {
            background: linear-gradient(to right, #CD853F, #8B4513);
            border-radius: 5px;
        }

        .slider::-ms-fill-upper {
            background: linear-gradient(to right, #CD853F, #8B4513);
            border-radius: 5px;
        }

        .slider::-ms-thumb {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: linear-gradient(135deg, #DAA520, #B8860B);
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            border: 2px solid white;
        }

        .slider-value {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .current-value {
            background: linear-gradient(135deg, #DAA520, #B8860B);
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 14px;
            min-width: 50px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .slider-info {
            font-size: 12px;
            color: #5D4037;
            opacity: 0.8;
        }

        .btn {
            background: linear-gradient(135deg, #DAA520, #B8860B);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            width: 100%;
        }

        .btn:hover {
            background: linear-gradient(135deg, #B8860B, #DAA520);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .message {
            background: rgba(139, 69, 19, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #8B4513;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .game-over {
            background: linear-gradient(135deg, #8B0000, #A52A2A);
            color: white;
            text-align: center;
            padding: 30px;
            border-radius: 15px;
            margin-top: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .victory {
            background: linear-gradient(135deg, #228B22, #32CD32);
            color: white;
            text-align: center;
            padding: 30px;
            border-radius: 15px;
            margin-top: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .install-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #8B4513;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            display: none;
            z-index: 1000;
        }

        @media (max-width: 600px) {
            .container { padding: 10px; }
            .header h1 { font-size: 2em; }
            .stats { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>⚱️ HAMMURABI ⚱️</h1>
            <p>Rule the ancient city of Babylon wisely</p>
        </div>

        <div class="game-board">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="year">1</div>
                    <div>Year of Reign</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="population">100</div>
                    <div>Population</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="acres">1000</div>
                    <div>Acres Owned</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="bushels">2800</div>
                    <div>Bushels in Store</div>
                </div>
            </div>

            <div id="messages"></div>

            <div class="controls" id="controls">
                <div class="input-group">
                    <label for="buy-acres">Acres to buy (1 acre = <span id="acre-price">19</span> bushels):</label>
                    <div class="slider-value">
                        <span class="slider-info">0</span>
                        <span class="current-value" id="buy-acres-value">0</span>
                        <span class="slider-info" id="max-buy-acres">147</span>
                    </div>
                    <div class="slider-container">
                        <input type="range" id="buy-acres" class="slider" min="0" max="147" value="0" 
                               oninput="updateSliderValue('buy-acres')" onchange="updateSliderValue('buy-acres')">
                    </div>
                </div>
                
                <div class="input-group">
                    <label for="sell-acres">Acres to sell:</label>
                    <div class="slider-value">
                        <span class="slider-info">0</span>
                        <span class="current-value" id="sell-acres-value">0</span>
                        <span class="slider-info" id="max-sell-acres">1000</span>
                    </div>
                    <div class="slider-container">
                        <input type="range" id="sell-acres" class="slider" min="0" max="1000" value="0"
                               oninput="updateSliderValue('sell-acres')" onchange="updateSliderValue('sell-acres')">
                    </div>
                </div>
                
                <div class="input-group">
                    <label for="feed-people">Bushels to feed people:</label>
                    <div class="slider-value">
                        <span class="slider-info">0</span>
                        <span class="current-value" id="feed-people-value">0</span>
                        <span class="slider-info" id="max-feed-people">2800</span>
                    </div>
                    <div class="slider-container">
                        <input type="range" id="feed-people" class="slider" min="0" max="2800" value="0"
                               oninput="updateSliderValue('feed-people')" onchange="updateSliderValue('feed-people')">
                    </div>
                </div>
                
                <div class="input-group">
                    <label for="plant-acres">Acres to plant:</label>
                    <div class="slider-value">
                        <span class="slider-info">0</span>
                        <span class="current-value" id="plant-acres-value">0</span>
                        <span class="slider-info" id="max-plant-acres">1000</span>
                    </div>
                    <div class="slider-container">
                        <input type="range" id="plant-acres" class="slider" min="0" max="1000" value="0"
                               oninput="updateSliderValue('plant-acres')" onchange="updateSliderValue('plant-acres')">
                    </div>
                </div>

                <button class="btn" onclick="nextTurn()">Execute Orders</button>
            </div>
        </div>
    </div>

    <button class="install-btn" id="installBtn" onclick="installPWA()">📱</button>

    <script>
        // Game state
        let gameState = {
            year: 1,
            population: 100,
            acres: 1000,
            bushels: 2800,
            acrePrice: 19,
            gameOver: false,
            totalDeaths: 0,
            plagueYear: false
        };

        // PWA functionality
        let deferredPrompt;
        const installBtn = document.getElementById('installBtn');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installBtn.style.display = 'block';
        });

        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        installBtn.style.display = 'none';
                    }
                    deferredPrompt = null;
                });
            }
        }

        // Create manifest dynamically
        const manifest = {
            name: "Hammurabi - Ancient Babylon",
            short_name: "Hammurabi",
            description: "Rule ancient Babylon in this classic strategy game",
            start_url: "./",
            display: "standalone",
            background_color: "#8B4513",
            theme_color: "#8B4513",
            icons: [
                {
                    src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%238B4513' width='100' height='100'/%3E%3Ctext y='50' x='50' text-anchor='middle' dominant-baseline='middle' font-size='60'%3E⚱️%3C/text%3E%3C/svg%3E",
                    sizes: "192x192",
                    type: "image/svg+xml"
                },
                {
                    src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%238B4513' width='100' height='100'/%3E%3Ctext y='50' x='50' text-anchor='middle' dominant-baseline='middle' font-size='60'%3E⚱️%3C/text%3E%3C/svg%3E",
                    sizes: "512x512",
                    type: "image/svg+xml"
                }
            ]
        };

        const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(manifestBlob);
        document.getElementById('manifest-placeholder').href = manifestURL;

        // Game functions
        function updateDisplay() {
            document.getElementById('year').textContent = gameState.year;
            document.getElementById('population').textContent = gameState.population;
            document.getElementById('acres').textContent = gameState.acres;
            document.getElementById('bushels').textContent = gameState.bushels;
            document.getElementById('acre-price').textContent = gameState.acrePrice;
            
            updateSliderLimits();
        }

        function updateSliderLimits() {
            // Calculate maximum values for sliders
            const maxBuyAcres = Math.floor(gameState.bushels / gameState.acrePrice);
            const maxSellAcres = gameState.acres;
            const maxFeedPeople = gameState.bushels;
            const maxPlantAcres = gameState.acres;

            // Update buy acres slider
            const buySlider = document.getElementById('buy-acres');
            buySlider.max = maxBuyAcres;
            document.getElementById('max-buy-acres').textContent = maxBuyAcres;
            document.getElementById('buy-acres-value').textContent = buySlider.value;

            // Update sell acres slider
            const sellSlider = document.getElementById('sell-acres');
            sellSlider.max = maxSellAcres;
            document.getElementById('max-sell-acres').textContent = maxSellAcres;
            document.getElementById('sell-acres-value').textContent = sellSlider.value;

            // Update feed people slider
            const feedSlider = document.getElementById('feed-people');
            feedSlider.max = maxFeedPeople;
            document.getElementById('max-feed-people').textContent = maxFeedPeople;
            document.getElementById('feed-people-value').textContent = feedSlider.value;

            // Update plant acres slider
            const plantSlider = document.getElementById('plant-acres');
            plantSlider.max = maxPlantAcres;
            document.getElementById('max-plant-acres').textContent = maxPlantAcres;
            document.getElementById('plant-acres-value').textContent = plantSlider.value;
        }

        function updateSliderValue(sliderId) {
            const slider = document.getElementById(sliderId);
            const valueDisplay = document.getElementById(sliderId + '-value');
            
            if (slider && valueDisplay) {
                valueDisplay.textContent = slider.value;
                
                // Update dependent sliders for resource management
                if (sliderId === 'buy-acres' || sliderId === 'sell-acres' || sliderId === 'feed-people') {
                    updateDependentSliders();
                }
            }
        }

        function setupSliderEvents() {
            // This function is now less critical since we use inline handlers
            // but we keep it for any additional setup if needed
        }

        function updateDependentSliders() {
            const buyAcres = parseInt(document.getElementById('buy-acres').value) || 0;
            const sellAcres = parseInt(document.getElementById('sell-acres').value) || 0;
            const feedPeople = parseInt(document.getElementById('feed-people').value) || 0;

            // Calculate remaining resources
            const acresAfterTrade = gameState.acres + buyAcres - sellAcres;
            const bushelsAfterPurchases = gameState.bushels - (buyAcres * gameState.acrePrice) + (sellAcres * gameState.acrePrice) - feedPeople;

            // Update plant acres slider based on available acres and bushels for seeds
            const maxPlantFromAcres = Math.max(0, acresAfterTrade);
            const maxPlantFromBushels = Math.max(0, Math.floor(bushelsAfterPurchases / 0.5));
            const maxPlantAcres = Math.min(maxPlantFromAcres, maxPlantFromBushels);

            const plantSlider = document.getElementById('plant-acres');
            plantSlider.max = maxPlantAcres;
            document.getElementById('max-plant-acres').textContent = maxPlantAcres;
            
            // Reset plant acres if it exceeds new maximum
            if (parseInt(plantSlider.value) > maxPlantAcres) {
                plantSlider.value = maxPlantAcres;
                document.getElementById('plant-acres-value').textContent = maxPlantAcres;
            }
        }

        function addMessage(text, isImportant = false) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            if (isImportant) {
                messageDiv.style.background = 'rgba(139, 69, 19, 0.2)';
                messageDiv.style.fontWeight = 'bold';
            }
            messageDiv.textContent = text;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            // Keep only last 5 messages
            while (messagesDiv.children.length > 5) {
                messagesDiv.removeChild(messagesDiv.firstChild);
            }
        }

        function random(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function nextTurn() {
            if (gameState.gameOver) return;

            // Get player inputs
            const buyAcres = parseInt(document.getElementById('buy-acres').value) || 0;
            const sellAcres = parseInt(document.getElementById('sell-acres').value) || 0;
            const feedPeople = parseInt(document.getElementById('feed-people').value) || 0;
            const plantAcres = parseInt(document.getElementById('plant-acres').value) || 0;

            // Validate inputs
            if (buyAcres * gameState.acrePrice > gameState.bushels) {
                addMessage("You don't have enough bushels to buy that much land!");
                return;
            }

            if (sellAcres > gameState.acres) {
                addMessage("You don't have that many acres to sell!");
                return;
            }

            if (feedPeople > gameState.bushels - (buyAcres * gameState.acrePrice)) {
                addMessage("You don't have enough bushels to feed that many people!");
                return;
            }

            const acresAfterTrade = gameState.acres + buyAcres - sellAcres;
            if (plantAcres > acresAfterTrade) {
                addMessage("You don't have enough acres to plant!");
                return;
            }

            const bushelsCost = (buyAcres * gameState.acrePrice) + feedPeople + (plantAcres * 0.5);
            if (bushelsCost > gameState.bushels) {
                addMessage("You don't have enough bushels for all these actions!");
                return;
            }

            // Execute turn
            gameState.acres = acresAfterTrade;
            gameState.bushels = gameState.bushels - (buyAcres * gameState.acrePrice) + (sellAcres * gameState.acrePrice) - feedPeople - Math.floor(plantAcres * 0.5);

            // Calculate harvest
            const yield = random(1, 5);
            const harvest = plantAcres * yield;
            gameState.bushels += harvest;

            addMessage(`Harvest: ${harvest} bushels from ${plantAcres} acres (${yield} bushels per acre)`);

            // Calculate population changes
            const peopleFed = Math.floor(feedPeople / 20);
            const starved = Math.max(0, gameState.population - peopleFed);
            
            if (starved > 0) {
                gameState.totalDeaths += starved;
                addMessage(`${starved} people starved to death!`, true);
            }

            gameState.population -= starved;

            // Check for plague
            gameState.plagueYear = random(1, 100) <= 15;
            if (gameState.plagueYear) {
                const plagueDeaths = Math.floor(gameState.population / 2);
                gameState.population -= plagueDeaths;
                gameState.totalDeaths += plagueDeaths;
                addMessage(`A horrible plague strikes! ${plagueDeaths} people died!`, true);
            }

            // Immigration
            if (starved === 0 && !gameState.plagueYear) {
                const immigrants = random(1, 5) + Math.floor((20 * gameState.acres + gameState.bushels) / gameState.population / 100) + 1;
                gameState.population += immigrants;
                addMessage(`${immigrants} people came to the city`);
            }

            // Rat damage
            const ratDamage = random(0, Math.floor(gameState.bushels / 3));
            gameState.bushels -= ratDamage;
            if (ratDamage > 0) {
                addMessage(`Rats ate ${ratDamage} bushels`);
            }

            // Update acre price for next year
            gameState.acrePrice = random(17, 26);
            gameState.year++;

            // Check game over conditions
            if (gameState.year > 10) {
                endGame();
                return;
            }

            if (gameState.population <= 0) {
                gameOver("Your population has died out! Your reign ends in failure.");
                return;
            }

            if (starved > gameState.population * 0.45) {
                gameOver("You starved too many people! The citizens revolt and overthrow you!");
                return;
            }

            // Reset sliders
            document.getElementById('buy-acres').value = 0;
            document.getElementById('sell-acres').value = 0;
            document.getElementById('feed-people').value = 0;
            document.getElementById('plant-acres').value = 0;

            updateDisplay();
        }

        function endGame() {
            gameState.gameOver = true;
            const acresPerPerson = gameState.acres / gameState.population;
            let rating;

            if (gameState.totalDeaths > 0.33 * gameState.population || acresPerPerson < 7) {
                rating = "Your performance was terrible! You're thrown out of office!";
            } else if (gameState.totalDeaths > 0.1 * gameState.population || acresPerPerson < 9) {
                rating = "Your performance was mediocre. A less than stellar reign.";
            } else if (gameState.totalDeaths > 0.03 * gameState.population || acresPerPerson < 10) {
                rating = "Your performance was good. The people are satisfied with your rule.";
            } else {
                rating = "Outstanding! You are a great ruler! Your people worship you!";
            }

            victory(`After 10 years of rule: Population: ${gameState.population}, Acres: ${gameState.acres}, Deaths: ${gameState.totalDeaths}. ${rating}`);
        }

        function gameOver(message) {
            gameState.gameOver = true;
            const gameBoard = document.querySelector('.game-board');
            const gameOverDiv = document.createElement('div');
            gameOverDiv.className = 'game-over';
            gameOverDiv.innerHTML = `
                <h2>💀 GAME OVER 💀</h2>
                <p>${message}</p>
                <button class="btn" onclick="location.reload()" style="margin-top: 20px; width: auto;">Play Again</button>
            `;
            gameBoard.appendChild(gameOverDiv);
            document.getElementById('controls').style.display = 'none';
        }

        function victory(message) {
            const gameBoard = document.querySelector('.game-board');
            const victoryDiv = document.createElement('div');
            victoryDiv.className = 'victory';
            victoryDiv.innerHTML = `
                <h2>👑 REIGN COMPLETE 👑</h2>
                <p>${message}</p>
                <button class="btn" onclick="location.reload()" style="margin-top: 20px; width: auto;">Play Again</button>
            `;
            gameBoard.appendChild(victoryDiv);
            document.getElementById('controls').style.display = 'none';
        }

        // Service Worker registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:text/javascript;base64,' + btoa(`
                const CACHE_NAME = 'hammurabi-v1';
                const urlsToCache = ['./'];

                self.addEventListener('install', event => {
                    event.waitUntil(
                        caches.open(CACHE_NAME)
                        .then(cache => cache.addAll(urlsToCache))
                    );
                });

                self.addEventListener('fetch', event => {
                    event.respondWith(
                        caches.match(event.request)
                        .then(response => response || fetch(event.request))
                    );
                });
            `)).catch(err => console.log('Service worker registration failed'));
        }

        // Initialize game when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            updateDisplay();
            setupSliderEvents();
            addMessage("Welcome, O King! You rule the city of Babylon. Make wise decisions to keep your people fed and your kingdom prosperous!");
        });

        // Fallback initialization if DOMContentLoaded already fired
        if (document.readyState === 'loading') {
            // Do nothing, wait for DOMContentLoaded
        } else {
            // DOM is already ready
            updateDisplay();
            setupSliderEvents();
            addMessage("Welcome, O King! You rule the city of Babylon. Make wise decisions to keep your people fed and your kingdom prosperous!");
        }
    </script>
</body>
</html>